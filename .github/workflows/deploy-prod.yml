name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  VAR_FILE: environments/prod/terraform.tfvars
  TFPLAN_BINARY: tfplan-${{ github.sha }}
  LAMBDA_ARTIFACT_NAME: lambda-functions-${{ github.sha }}
  LAMBDA_BUILD_DIR: ${{ github.workspace }}/dist

jobs:
  plan:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.plan-exitcode }}

    steps:
      - name: Validate Deploy Confirmation
        id: confirm
        if: github.event.inputs.confirm != 'deploy'
        run: |
          echo "::error::Deployment confirmation required. Please type 'deploy' to proceed."
          exit 1

      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_TF_PLAN_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        id: setup
        uses: ./.github/actions/terraform-setup
        with:
          terraform-version: ${{ vars.TERRAFORM_VERSION }}
          backend-config: environments/prod/backend.tfbackend

      - name: Validate Terraform
        id: validate
        uses: ./.github/actions/terraform-validate
        with:
          ignore-fmt-error: true

      - name: Build Lambda Functions
        id: build
        uses: ./.github/actions/lambda-build
        with:
          lambda-build-dir: ${{ env.LAMBDA_BUILD_DIR }}
          lambda-artifact-name: ${{ env.LAMBDA_ARTIFACT_NAME }}
          upload-lambda-artifact: true

      - name: Plan Terraform
        id: plan
        uses: ./.github/actions/terraform-plan
        with:
          upload-plan-artifact: true
          tfplan-binary: ${{ env.TFPLAN_BINARY }}
          var-file: ${{ env.VAR_FILE }}

      - name: Create Plan Summary
        if: ${{ always() && steps.confirm.outcome != 'failure' }}
        run: |
          source ${{ github.workspace }}/.github/scripts/utils/constants.sh

          echo "## üìä Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚öôÔ∏è Init | ${OUTCOMES[${{ steps.setup.outputs.init-outcome }}]} ${{ steps.setup.outputs.init-outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "| üìù Format | ${OUTCOMES[${{ steps.validate.outputs.fmt-outcome }}]} ${{ steps.validate.outputs.fmt-outcome}}" >> $GITHUB_STEP_SUMMARY
          echo "| üõ°Ô∏è Validate | ${OUTCOMES[${{ steps.validate.outputs.validate-outcome }}]} ${{ steps.validate.outputs.validate-outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "| üî® Build | ${OUTCOMES[${{ steps.build.outputs.build-outcome }}]} ${{ steps.build.outputs.build-outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üìã Plan | ${OUTCOMES[${{ steps.plan.outputs.plan-outcome }}]} ${{ steps.plan.outputs.plan-outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìã Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.plan.outputs.plan-exitcode }}" == "0" ]]; then
            echo "### ‚úÖ No Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is up to date. No changes required." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.plan-exitcode }}" == "2" ]]; then
            echo "### ‚ö†Ô∏è Changes Detected - Review Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üîç Click to view detailed plan</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```terraform' >> $GITHUB_STEP_SUMMARY
            terraform show $TFPLAN_BINARY -no-color >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Plan Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the workflow logs for error details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        working-directory: terraform/

      - name: Post Slack Message
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID_PROD }}",
              "text": "${{ job.status == 'success' && steps.plan.outputs.plan-exitcode == '0' && 'Terraform Plan - Infrastructure: No Changes Detected' || job.status == 'success' && steps.plan.outputs.plan-exitcode == '2' && 'Terraform Plan - Infrastructure: Changes Detected' || 'Terraform Plan - Infrastructure (Production): Failed' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && steps.plan.outputs.plan-exitcode == '0' && 'üìã Terraform Plan - Infrastructure: ‚úÖ No Changes Detected' || job.status == 'success' && steps.plan.outputs.plan-exitcode == '2' && 'üìã Terraform Plan - Infrastructure: ‚ö†Ô∏è Changes Detected' || 'üìã Terraform Plan - Infrastructure: ‚ùå Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|`${{ github.sha }}`>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  apply:
    needs: plan
    if: ${{ github.ref == 'refs/heads/main' && needs.plan.outputs.plan_exitcode == '2' }}
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_TF_APPLY_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        id: setup
        uses: ./.github/actions/terraform-setup
        with:
          terraform-version: ${{ vars.TERRAFORM_VERSION }}
          backend-config: environments/prod/backend.tfbackend

      - name: Download Lambda Build Artifacts
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.LAMBDA_ARTIFACT_NAME }}
          path: ${{ env.LAMBDA_BUILD_DIR }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.TFPLAN_BINARY }}
          path: terraform/

      - name: Drift Detection
        id: drift
        run: |
          chmod +x "$DRIFT_SCRIPT"
          "$DRIFT_SCRIPT"
        env:
          DRIFT_SCRIPT: ${{ github.workspace }}/.github/scripts/drift-detection.sh
        working-directory: terraform/

      - name: Apply Terraform
        id: apply
        run: |
          terraform apply \
            "$TFPLAN_BINARY" \
            -no-color
        working-directory: terraform/

      - name: Create Apply Summary
        if: always()
        run: |
          source ${{ github.workspace}}/.github/scripts/utils/constants.sh

          echo "## üìä Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚öôÔ∏è Init | ${OUTCOMES[${{ steps.setup.outputs.init-outcome }}]} ${{ steps.setup.outputs.init-outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîç Drift Detection | ${OUTCOMES[${{ steps.drift.outcome }}]} ${{ steps.drift.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ Apply | ${OUTCOMES[${{ steps.apply.outcome }}]} ${{ steps.apply.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üöÄ Apply" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.apply.outcome }}" == "success" ]]; then
            echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the workflow logs for error details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Post Slack Message
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID_PROD }}",
              "text": "${{ job.status == 'success' && 'Terraform Apply - Infrastructure: Successful' || 'Terraform Apply - Infrastructure: Failed' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && 'üöÄ Terraform Apply - Infrastructure: ‚úÖ Successful' || 'üöÄ Terraform Apply - Infrastructure: ‚ùå Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|`${{ github.sha }}`>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
