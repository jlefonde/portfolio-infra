name: Deploy Production

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: 'Type "deploy" to confirm production deployment'
        required: true
        type: string

permissions:
  id-token: write
  contents: read

env:
  VAR_FILE: environments/prod/terraform.tfvars
  TFPLAN_BINARY: tfplan-${{ github.sha }}
  LAMBDA_ARTIFACT_NAME: lambda-functions-${{ github.sha }}
  TF_VAR_lambda_build_dir: ${{ github.workspace }}/dist

jobs:
  plan:
    if: ${{ github.ref == 'refs/heads/main' }}
    runs-on: ubuntu-latest
    outputs:
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}

    steps:
      - name: Validate Deploy Confirmation
        id: confirm
        if: github.event.inputs.confirm != 'deploy'
        run: |
          echo "::error::Deployment confirmation required. Please type 'deploy' to proceed."
          exit 1

      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_TF_PLAN_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ vars.TERRAFORM_VERSION }}

      - name: Initialize Terraform
        id: init
        run: terraform init -input=false
        working-directory: terraform/

      - name: Format Terraform
        id: fmt
        run: terraform fmt -recursive -check
        working-directory: terraform/
        continue-on-error: true

      - name: Validate Terraform
        id: validate
        working-directory: terraform/
        run: terraform validate -no-color

      - name: Build Lambda Functions
        id: build
        run: |
          echo "Searching for Lambda functions..."
          lambda_dirs=$(find ./lambda/ -name "main.go" -printf '%h\n' | sort -u)

          lambda_count=$(echo "$lambda_dirs" | wc -l)
          echo "Found $lambda_count Lambda function(s) to build"
          echo ""

          echo "Output directory: ${{ env.TF_VAR_lambda_build_dir }}"
          mkdir -p "${{ env.TF_VAR_lambda_build_dir }}"
          echo ""

          for dir in $lambda_dirs; do
            func_name=$(basename "$dir")

            echo "Building lambda function: $func_name"
            echo "  - Source: $dir"
            echo "  - Target: ${{ env.TF_VAR_lambda_build_dir }}/$func_name.zip"

            cd "$dir"

            output_binary="${{ env.TF_VAR_lambda_build_dir }}/bootstrap"
            if GOOS=linux GOARCH=amd64 CGO_ENABLED=0 go build -trimpath -o "$output_binary" main.go; then
                binary_size=$(stat -c%s "$output_binary" | numfmt --to=iec-i --suffix=B)
                
                TZ=UTC touch -t 202001010000.00 "$output_binary"
                zip -X -j "${{ env.TF_VAR_lambda_build_dir }}/$func_name.zip" "$output_binary"
                TZ=UTC touch -t 202001010000.00 "${{ env.TF_VAR_lambda_build_dir }}/$func_name.zip"

                rm "$output_binary"
                echo "Build successful (size: $binary_size)"
            else
                echo "Error: Build failed"
                exit 1
            fi
            
            cd - > /dev/null
            echo ""
          done

          echo "All Lambda functions compiled successfully"
          echo ""

      - name: Upload Lambda Build Artifacts
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.LAMBDA_ARTIFACT_NAME }}
          path: ${{ env.TF_VAR_lambda_build_dir }}
          if-no-files-found: error
          overwrite: true
          retention-days: 5

      - name: Plan Terraform
        id: plan
        run: |
          set +e
          terraform plan \
            -var-file="$VAR_FILE" \
            -out="$TFPLAN_BINARY" \
            -detailed-exitcode \
            -no-color \
            -input=false

          TF_EXITCODE=$?
          set -e

          [[ $TF_EXITCODE -ne 1 ]] || exit 1
        working-directory: terraform/

      - name: Upload Plan Artifact
        uses: actions/upload-artifact@v5
        with:
          name: ${{ env.TFPLAN_BINARY }}
          path: terraform/${{ env.TFPLAN_BINARY }}
          if-no-files-found: error
          overwrite: true
          retention-days: 5

      - name: Create Plan Summary
        if: ${{ always() && steps.confirm.outcome != 'failure' }}
        run: |
          declare -gA outcomes=(
            ["success"]="‚úÖ"
            ["failure"]="‚ùå"
            ["cancelled"]="‚õî"
            ["skipped"]="‚è≠Ô∏è"
          )

          echo "## üìä Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚öôÔ∏è Init | ${outcomes[${{ steps.init.outcome }}]} ${{ steps.init.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "| üìù Format | ${outcomes[${{ steps.fmt.outcome }}]} ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "| üõ°Ô∏è Validate | ${outcomes[${{ steps.validate.outcome }}]} ${{ steps.validate.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "| üî® Build | ${outcomes[${{ steps.build.outcome }}]} ${{ steps.build.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üìã Plan | ${outcomes[${{ steps.plan.outcome }}]} ${{ steps.plan.outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìã Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.plan.outputs.exitcode }}" == "0" ]]; then
            echo "### ‚úÖ No Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is up to date. No changes required." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.exitcode }}" == "2" ]]; then
            echo "### ‚ö†Ô∏è Changes Detected - Review Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üîç Click to view detailed plan</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```terraform' >> $GITHUB_STEP_SUMMARY
            terraform show $TFPLAN_BINARY -no-color >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Plan Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the workflow logs for error details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        working-directory: terraform/

      - name: Post Slack Message
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID_PROD }}",
              "text": "${{ job.status == 'success' && steps.plan.outputs.exitcode == '0' && 'Terraform Plan - Infrastructure (Production): No Changes Detected' || job.status == 'success' && steps.plan.outputs.exitcode == '2' && 'Terraform Plan - Infrastructure (Production): Changes Detected' || 'Terraform Plan - Infrastructure (Production): Failed' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && steps.plan.outputs.exitcode == '0' && 'üìã Terraform Plan - Infrastructure: ‚úÖ No Changes' || job.status == 'success' && steps.plan.outputs.exitcode == '2' && 'üìã Terraform Plan - Infrastructure: ‚ö†Ô∏è Changes Detected' || 'üìã Terraform Plan - Infrastructure: ‚ùå Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Service:*\nInfrastructure"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Triggered by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|`${{ github.sha }}`>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }

  apply:
    needs: plan
    if: ${{ github.ref == 'refs/heads/main' && needs.plan.outputs.plan_exitcode == '2' }}
    runs-on: ubuntu-latest
    environment: prod
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_TF_APPLY_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Install Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ vars.TERRAFORM_VERSION }}

      - name: Initialize Terraform
        id: init
        run: terraform init -input=false
        working-directory: terraform/

      - name: Download Lambda Build Artifacts
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.LAMBDA_ARTIFACT_NAME }}
          path: ${{ env.TF_VAR_lambda_build_dir }}

      - name: Download Plan Artifact
        uses: actions/download-artifact@v5
        with:
          name: ${{ env.TFPLAN_BINARY }}
          path: terraform/

      - name: Drift Detection
        id: drift
        run: |
          TFPLAN_DRIFT_CHECK="tfplan-drift-check"
          set +e
          terraform plan \
            -var-file="$VAR_FILE" \
            -out="$TFPLAN_DRIFT_CHECK" \
            -detailed-exitcode \
            -no-color \
            -input=false

          TF_EXITCODE=$?
          set -e

          if [[ $TF_EXITCODE -eq 0 ]]; then
            echo "No drift detected - infrastructure matches expected state"
          elif [[ $TF_EXITCODE -eq 2 ]]; then
            echo "Warning: State has drifted - comparing plans..."
            
            terraform show -no-color "$TFPLAN_DRIFT_CHECK" > drift-check.txt
            terraform show -no-color "$TFPLAN_BINARY" > original-plan.txt

            sed -n '/Terraform will perform the following actions:/,$p' original-plan.txt > original-changes.txt
            sed -n '/Terraform will perform the following actions:/,$p' drift-check.txt > drift-changes.txt

            if diff -u original-changes.txt drift-changes.txt > plan-diff.txt; then
              echo "Plans are identical"
            else
              echo "Warning: Plans differ - showing differences..."
              echo ""
              echo "=== Plan Differences ==="
              cat plan-diff.txt

              exit 1
            fi
          else
            echo "Error: Drift check failed"
            exit 1
          fi
        working-directory: terraform/

      - name: Apply Terraform
        id: apply
        run: |
          terraform apply \
            "$TFPLAN_BINARY" \
            -no-color
        working-directory: terraform/

      - name: Create Apply Summary
        if: always()
        run: |
          declare -gA outcomes=(
            ["success"]="‚úÖ"
            ["failure"]="‚ùå"
            ["cancelled"]="‚õî"
            ["skipped"]="‚è≠Ô∏è"
          )

          echo "## üìä Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚öôÔ∏è Init | ${outcomes[${{ steps.init.outcome }}]} ${{ steps.init.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üîç Drift Detection | ${outcomes[${{ steps.drift.outcome }}]} ${{ steps.drift.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üöÄ Apply | ${outcomes[${{ steps.apply.outcome }}]} ${{ steps.apply.outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üöÄ Apply" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.apply.outcome }}" == "success" ]]; then
            echo "### ‚úÖ Deployment Successful" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Deployment Failed" >> $GITHUB_STEP_SUMMARY
            echo "Please review the workflow logs for error details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY

      - name: Post Slack Message
        if: always()
        uses: slackapi/slack-github-action@v2.1.1
        with:
          method: chat.postMessage
          token: ${{ secrets.SLACK_BOT_TOKEN }}
          payload: |
            {
              "channel": "${{ vars.SLACK_CHANNEL_ID_PROD }}",
              "text": "${{ job.status == 'success' && 'Terraform Apply - Infrastructure (Production): Successful' || 'Terraform Apply - Infrastructure (Production): Failed' }}",
              "blocks": [
                {
                  "type": "header",
                  "text": {
                    "type": "plain_text",
                    "text": "${{ job.status == 'success' && 'üöÄ Terraform Apply - Infrastructure: ‚úÖ Successful' || 'üöÄ Terraform Apply - Infrastructure: ‚ùå Failed' }}"
                  }
                },
                {
                  "type": "section",
                  "fields": [
                    {
                      "type": "mrkdwn",
                      "text": "*Service:*\nInfrastructure"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Environment:*\nProduction"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Deployed by:*\n${{ github.actor }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Branch:*\n${{ github.ref_name }}"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Commit:*\n<${{ github.server_url }}/${{ github.repository }}/commit/${{ github.sha }}|`${{ github.sha }}`>"
                    },
                    {
                      "type": "mrkdwn",
                      "text": "*Repository:*\n<${{ github.server_url }}/${{ github.repository }}|${{ github.repository }}>"
                    }
                  ]
                },
                {
                  "type": "actions",
                  "elements": [
                    {
                      "type": "button",
                      "text": {
                        "type": "plain_text",
                        "text": "View Workflow"
                      },
                      "url": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
                    }
                  ]
                }
              ]
            }
