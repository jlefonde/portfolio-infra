name: PR - Terraform Plan

on:
  pull_request:
    branches:
      - main
    types:
      - opened
      - synchronize
      - reopened

permissions:
  id-token: write
  contents: read
  pull-requests: write

env:
  VAR_FILE: environments/dev/terraform.tfvars
  TFPLAN_BINARY: tfplan-${{ github.sha }}
  LAMBDA_BUILD_DIR: ${{ github.workspace }}/dist

jobs:
  plan:
    runs-on: ubuntu-latest
    environment: dev
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v5

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ vars.AWS_TF_ROLE_ARN }}
          aws-region: ${{ vars.AWS_REGION }}

      - name: Setup Terraform
        id: setup
        uses: ./.github/actions/terraform-setup
        with:
          terraform-version: ${{ vars.TERRAFORM_VERSION }}
          backend-config: environments/dev/backend.tfbackend

      - name: Validate Terraform
        id: validate
        uses: ./.github/actions/terraform-validate
        with:
          ignore-fmt-error: false

      - name: Build Lambda Functions
        id: build
        uses: ./.github/actions/lambda-build
        with:
          lambda-build-dir: ${{ env.LAMBDA_BUILD_DIR }}

      - name: Plan Terraform
        id: plan
        uses: ./.github/actions/terraform-plan
        with:
          upload-plan-artifact: false
          tfplan-binary: ${{ env.TFPLAN_BINARY }}
          var-file: ${{ env.VAR_FILE }}

      - name: Create Plan Summary
        if: always()
        run: |
          source ${{ github.workspace }}/.github/scripts/utils/constants.sh

          echo "## üìä Overview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Step | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|------|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| ‚öôÔ∏è Init | ${OUTCOMES[${{ steps.setup.outputs.init-outcome }}]} ${{ steps.setup.outputs.init-outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "| üìù Format | ${OUTCOMES[${{ steps.validate.outputs.fmt-outcome }}]} ${{ steps.validate.outputs.fmt-outcome}}" >> $GITHUB_STEP_SUMMARY
          echo "| üõ°Ô∏è Validate | ${OUTCOMES[${{ steps.validate.outputs.validate-outcome }}]} ${{ steps.validate.outputs.validate-outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "| üî® Build | ${OUTCOMES[${{ steps.build.outputs.build-outcome }}]} ${{ steps.build.outputs.build-outcome }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üìã Plan | ${OUTCOMES[${{ steps.plan.outputs.plan-outcome }}]} ${{ steps.plan.outputs.plan-outcome }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "## üìã Plan" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [[ "${{ steps.plan.outputs.plan-exitcode }}" == "0" ]]; then
            echo "### ‚úÖ No Changes Detected" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure is up to date. No changes required." >> $GITHUB_STEP_SUMMARY
          elif [[ "${{ steps.plan.outputs.plan-exitcode }}" == "2" ]]; then
            echo "### ‚ö†Ô∏è Changes Detected - Review Required" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "<details>" >> $GITHUB_STEP_SUMMARY
            echo "<summary>üîç Click to view detailed plan</summary>" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo '```terraform' >> $GITHUB_STEP_SUMMARY
            terraform show $TFPLAN_BINARY -no-color >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "</details>" >> $GITHUB_STEP_SUMMARY
          else
            echo "### ‚ùå Plan Failed" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "Please review the workflow logs for error details." >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp:** $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** \`${{ github.sha }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Triggered by:** @${{ github.actor }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** \`${{ github.ref_name }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Workflow:** [${{ github.workflow }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})" >> $GITHUB_STEP_SUMMARY
        
          cat $GITHUB_STEP_SUMMARY >> "${{ github.workspace }}/summary.md"
        working-directory: terraform/

      - name: Comment Pull Request
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v8
        with:
          script: |
            const fs = require('fs');
            const summary = fs.readFileSync("${{ github.workspace }}/summary.md", 'utf8').trim();

            await github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: summary
              });
